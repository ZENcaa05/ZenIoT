<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Kendali Lampu via MQTT</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
  <style>
    body {
      background-color: #f8f9fa;
      font-family: 'Segoe UI', sans-serif;
    }
    .card {
      max-width: 400px;
      margin: 100px auto;
      text-align: center;
      box-shadow: 0 4px 20px rgba(0,0,0,0.1);
      border-radius: 20px;
      padding: 30px;
    }
    .btn-toggle {
      font-size: 1.5rem;
      padding: 15px 40px;
      border-radius: 50px;
    }
    .status-text {
      font-size: 1.2rem;
      margin-top: 20px;
    }
  </style>
</head>
<body>
  <div class="card">
    <h3 class="mb-4">Kendali Lampu MQTT</h3>
    <button id="toggleBtn" class="btn btn-success btn-toggle">Nyalakan</button>
    <div class="status-text mt-3">
      Status: <span id="lampStatus" class="fw-bold text-secondary">Tidak Diketahui</span>
    </div>
  </div>

  <script>
    const broker = "wss://broker.hivemq.com:8884/mqtt";
    const topicControl = "esp/relay";
    const topicStatus = "esp/status";

    const client = mqtt.connect(broker, {
      clientId: "web-btn-" + Math.random().toString(16).substr(2, 8)
    });

    let lampOn = false; // status lokal

    const toggleBtn = document.getElementById("toggleBtn");
    const lampStatus = document.getElementById("lampStatus");

    // Saat tombol diklik
    toggleBtn.addEventListener("click", () => {
      const state = lampOn ? "off" : "on";
      client.publish(topicControl, "1:" + state); // hanya relay 1
    });

    // Saat terhubung
    client.on("connect", () => {
      console.log("Terhubung ke MQTT");
      client.subscribe(topicStatus);
    });

    // Saat menerima pesan status dari ESP
    client.on("message", (topic, message) => {
      if (topic === topicStatus) {
        const data = JSON.parse(message.toString());
        lampOn = data["relay1"]; // ambil status relay1
        updateUI();
      }
    });

    function updateUI() {
      if (lampOn) {
        toggleBtn.classList.remove("btn-success");
        toggleBtn.classList.add("btn-danger");
        toggleBtn.textContent = "Matikan";
        lampStatus.textContent = "Lampu ON";
        lampStatus.classList.remove("text-secondary", "text-danger");
        lampStatus.classList.add("text-success");
      } else {
        toggleBtn.classList.remove("btn-danger");
        toggleBtn.classList.add("btn-success");
        toggleBtn.textContent = "Nyalakan";
        lampStatus.textContent = "Lampu OFF";
        lampStatus.classList.remove("text-secondary", "text-success");
        lampStatus.classList.add("text-danger");
      }
    }
  </script>
</body>
</html>
